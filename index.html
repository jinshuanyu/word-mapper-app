<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>英文拼字 × 聲音對照</title>

  <!-- 字體 & Icons（可留可去） -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --muted: #6b7a90;
      --text: #1b2430;
      --line: #e3e8f2;
      --accent: #111827;
      --ok: #16a34a;
      --err: #dc2626;
      --btn: #eef2f7;
      --btn-border: #d5dbe7;
      --btn-hover: #e1e7f2;
    }
    * { box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Noto Sans TC', 'Helvetica Neue', Arial, sans-serif;
      margin: 0; padding: 24px;
    }
    .wrap { max-width: 960px; margin: 0 auto; }
    h1 { font-size: 22px; font-weight: 700; margin: 0 0 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-bottom: 16px; }
    select, button {
      border: 1px solid var(--btn-border);
      background: var(--card);
      padding: 8px 10px; border-radius: 8px; font-size: 14px;
    }
    button:hover { background: var(--btn-hover); cursor: pointer; }
    .card {
      background: var(--card); border: 1px solid var(--line);
      border-radius: 16px; box-shadow: 0 4px 20px rgba(18,28,45,.04);
      padding: 16px; margin-bottom: 20px;
    }
    .word-row { display: grid; grid-template-columns: 180px 1fr 120px; gap: 8px; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--line); }
    .word-row:last-child { border-bottom: 0; }
    .word { font-weight: 700; font-size: 16px; }
    .phonemes { display: flex; flex-wrap: wrap; gap: 8px; }
    .phoneme-box {
      border: 1px solid var(--btn-border); padding: 6px 10px; border-radius: 10px;
      background: var(--btn); cursor: pointer; font-family: "Noto Sans", sans-serif;
      user-select: none;
    }
    .phoneme-box:hover { background: var(--btn-hover); }
    .pill { font-size: 12px; color: var(--muted); }
    .footer { margin-top: 28px; text-align: center; color: var(--muted); }
    .credits { margin-top: 28px; text-align: center; color: var(--muted); }
    .ok { color: var(--ok); }
    .err { color: var(--err); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>英文拼字 × 聲音對照</h1>

    <div class="row">
      <div>
        <label for="topicSel" class="pill">Topic</label><br>
        <select id="topicSel"></select>
      </div>
      <div>
        <label for="levelSel" class="pill">Level</label><br>
        <select id="levelSel"></select>
      </div>
      <div style="margin-left:auto">
        <button id="reloadBtn">Reload</button>
      </div>
    </div>

    <div id="list" class="card" aria-live="polite"></div>

    <footer class="credits">
      © 2025 Christina Yu. All rights reserved.<br /><br />
      <a href="mailto:mamahowma@gmail.com" aria-label="Email mamahowma">
        <i class="fa-solid fa-envelope fa-xl fa-fw" aria-hidden="true"></i>
      </a>&emsp;
      <a href="https://www.facebook.com/mamahowma" target="_blank" rel="noopener noreferrer" aria-label="mamahowma Facebook Page">
        <i class="fa-brands fa-facebook fa-xl fa-fw" aria-hidden="true"></i>
      </a>&emsp;
      <a href="https://portaly.cc/mamahowma/support" target="_blank" rel="noopener noreferrer" aria-label="Support mamahowma">
        <i class="fa-solid fa-mug-hot fa-xl fa-fw" aria-hidden="true"></i>
      </a>
    </footer>
  </div>

  <script>
  // ====== 常數 ======
  const TOPICS_URL = 'topics.json';
  const PHONEME_MAP_URL = 'data/phoneme-audio.json';

  // ====== 工具 ======
  async function fetchJSON(url) {
    const abs = new URL(url, location.href).href;
    const r = await fetch(abs, { cache: 'no-store' });
    if (!r.ok) throw new Error(`HTTP ${r.status} for ${abs}`);
    return r.json();
  }

  // 清理鍵值：去 HTML 標籤、去掉 ' / ’、去空白、去首尾斜線
  function cleanKey(raw){
    return String(raw)
      .replace(/<[^>]+>/g, '')   // <u>th</u> → th
      .replace(/['’]/g, '')      // 'tʃ / ’tʃ → tʃ
      .trim()
      .replace(/^\/|\/$/g, '')   // /tʃ/ → tʃ
      .replace(/\s+/g, '');      // 空白
  }

  // slug 規則（單字音檔）
  function slugify(s){
    return String(s).toLowerCase()
      .normalize('NFKD').replace(/[\u0300-\u036f]/g,'') // 去重音
      .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  }

  // 依題目檔路徑產 levelFolder（data/numbers-1.json → numbers-1）
  function levelFolderFromSrc(src){
    return String(src).replace(/^data\//,'').replace(/\.json$/,'');
  }

  // 播放
  async function playAudio(url, el){
    if(!url) return;
    try {
      const a = new Audio(url);
      await a.play();
      console.log('🔊', url);
      if (el) el.classList.add('ok'); // 小提示
    } catch (e) {
      console.error('❌ play error', url, e);
      if (el) el.classList.add('err');
    } finally {
      if (el) setTimeout(()=>{ el.classList.remove('ok','err'); }, 600);
    }
  }

  // 從 phoneme 對照表取得 URL（先用原樣，再用清理後的鍵）
  function getPhonemeUrl(raw, files){
    const key = cleanKey(raw);
    return files[raw] || files[key] || '';
  }

  // ====== 主流程 ======
  let PHONEME = { files: {} };
  let TOPICS = { topics: [] };
  let CURRENT_LEVEL = null; // 目前載入的 level（包含：src、label）

  const topicSel = document.getElementById('topicSel');
  const levelSel  = document.getElementById('levelSel');
  const listEl   = document.getElementById('list');
  const reloadBtn = document.getElementById('reloadBtn');

  async function init(){
    // 讀對照表與主題表
    [PHONEME, TOPICS] = await Promise.all([
      fetchJSON(PHONEME_MAP_URL),
      fetchJSON(TOPICS_URL)
    ]);

    // 畫 Topic 下拉
    topicSel.innerHTML = TOPICS.topics.map((t, i)=> `<option value="${i}">${t.title||t.slug||('Topic '+(i+1))}</option>`).join('');
    topicSel.onchange = () => renderLevels();
    renderLevels();

    // 事件：Reload
    reloadBtn.onclick = () => {
      if (CURRENT_LEVEL) loadLevel(CURRENT_LEVEL);
    };

    // 點擊事件委派：phoneme / word 播放
    listEl.addEventListener('click', e=>{
      const box = e.target.closest('.phoneme-box');
      if (box) {
        const raw = box.innerHTML; // 支援 <u>th</u>、-j-、以及前後空白/引號
        const url = getPhonemeUrl(raw, PHONEME.files);
        console.log('raw=', raw, ' | cleaned=', cleanKey(raw), ' | url=', url);
        return playAudio(url, box);
      }
      const wb = e.target.closest('.word-play');
      if (wb && CURRENT_LEVEL) {
        const word = wb.getAttribute('data-word') || '';
        const levelFolder = levelFolderFromSrc(CURRENT_LEVEL.src);
        const explicit = wb.getAttribute('data-audio'); // 若題目有自帶 audio 欄位
        const url = explicit || `audio/${levelFolder}/${slugify(word)}.mp3`;
        return playAudio(url, wb);
      }
    });
  }

  function renderLevels(){
    const t = TOPICS.topics[Number(topicSel.value)||0] || { levels: [] };
    const lv = t.levels || [];
    levelSel.innerHTML = lv.map((x,i)=> `<option value="${i}">${x.label||('Lv '+(i+1))}</option>`).join('');
    levelSel.onchange = () => {
      const L = lv[Number(levelSel.value)||0];
      L && loadLevel(L);
    };
    // 預設載入第一個 level
    const L = lv[0];
    if (L) loadLevel(L);
    else {
      listEl.innerHTML = `<div class="pill">此 Topic 尚無資料。</div>`;
    }
  }

  async function loadLevel(levelMeta){
    CURRENT_LEVEL = levelMeta;
    const levelFolder = levelFolderFromSrc(levelMeta.src||'');
    let items = [];
    try {
      items = await fetchJSON(levelMeta.src);
    } catch (e) {
      listEl.innerHTML = `<div class="err">載入失敗：${e.message}</div>`;
      return;
    }
    // 預期 items 為陣列：[{ word: 'three', phonemes: ["/θ","r","i/"], audio?: "..." }, ...]
    listEl.innerHTML = items.map(it=>{
      const word = it.word || it.text || '';
      const phonemes = Array.isArray(it.phonemes) ? it.phonemes : [];
      const wordAudio = it.audio ? String(it.audio) : ''; // 可選：顯式路徑
      const phonemeBoxes = phonemes.map(p => `<span class="phoneme-box" role="button" tabindex="0">${p}</span>`).join('');
      return `
        <div class="word-row">
          <div class="word">${word}</div>
          <div class="phonemes">${phonemeBoxes}</div>
          <div>
            <button class="word-play" data-word="${word}" ${wordAudio ? `data-audio="${wordAudio}"` : ''}>
              <i class="fa-solid fa-play"></i>  播單字
            </button>
          </div>
        </div>
      `;
    }).join('') || `<div class="pill">此 Level 沒有項目。</div>`;
  }

  // 啟動
  init().catch(e=>{
    console.error(e);
    listEl.innerHTML = `<div class="err">初始化失敗：${e.message}</div>`;
  });
  </script>
</body>
</html>
