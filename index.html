<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no"/>
  <title>è‹±æ–‡æ‹¼å­— Ã— è²éŸ³å°ç…§</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&family=Noto+Sans:wght@400;700&family=Noto+Sans+TC:wght@400;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root{ --c-primary:#887ea6; --c-secondary:#10b981; --c-text:#1f2937; --c-bg:#f8fafc; --c-border:#e2e8f0; }

    /* tag é¡åˆ¥è‰² */
    .tag-irregular{background:#fee2e2;border-color:#ef4444;color:#991b1b;}

.tag-cvc{
  background:#fff;        /* ç™½åº• */
  color:#065f46;          /* æ·±ç¶ å­—ï¼ˆTailwind teal-900 / emerald-900ä¸€å¸¶ï¼‰*/
  border-color:#065f46;   /* æ·±ç¶ é‚Šæ¡† */
}

    .tag-closed{background:#d1fae5;border-color:#10b981;color:#065f46;}
    .tag-floss{background:#ffe4e6;border-color:#fb7185;color:#9f1239;}
    .tag-digraph{background:#e0f2fe;border-color:#38bdf8;color:#075985;}
    .tag-cluster{background:#ede9fe;border-color:#8b5cf6;color:#4c1d95;}
    .tag-suffix{background:#ccfbf1;border-color:#14b8a6;color:#0f766e;}
    .tag-rcontrolled{background:#e9d5ff;border-color:#a855f7;color:#581c87;}
    .tag-open{background:#dcfce7;border-color:#22c55e;color:#14532d;}
    .tag-cle{background:#f5f5f4;border-color:#a8a29e;color:#3f3f46;}
    .tag-magic_e{background:#dbeafe;border-color:#3b82f6;color:#1e40af;}
    .tag-vowel_team{background:#ffedd5;border-color:#f97316;color:#9a3412;}
  
    .tag-silent_consonant{background:#f1f5f9;border-color:#94a3b8;color:#334155;}

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;overflow-x:hidden}
    body{font-family:"Inter",system-ui,-apple-system,"Noto Sans TC",sans-serif;background:var(--c-bg);color:var(--c-text);padding:1rem 0;line-height:1.6;font-size:18px}
    .container{max-width:1200px;margin:0 auto;padding:1.5rem 1rem;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);min-height:90vh}
    h1{font-family:'Noto Sans TC',sans-serif;font-size:2rem;font-weight:800;color:#0f172a;text-align:center;margin-bottom:2rem}

    /* Page switch */
    .page-section{display:none;min-height:50vh}
    .page-section.active{display:block}
    #homePage{flex-direction:column;align-items:center;justify-content:flex-start}
    #homePage.active{display:flex}
    #homePage:not(.active){display:none!important}

    /* 2-line dropdown UI */
    .dropdown-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: .9rem;
      margin-bottom: 2.5rem;
      font-size: 1.15rem;
    }
    .dropdown-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: .9rem;
    }
    .dropdown-select {
      min-width: 230px;
      padding: .7rem 1rem;
      border: 2px solid #cbd5e1;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      background: #f8fafc;
      transition: all .2s;
    }
    .dropdown-select:focus {
      outline: none;
      border-color: var(--c-primary);
      box-shadow: 0 0 0 3px rgba(124,58,237,0.15);
    }
    .dropdown-btn {
      background: #9b94b0;
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: .7rem 1.4rem;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: background .2s, transform .1s;
    }
    .dropdown-btn:hover { background: #887ea6; transform: translateY(-2px); }
    .dropdown-btn:active { transform: translateY(0); }

    /* Home list placeholder (we now use dropdowns) */
    .topic-list{list-style:none;padding:0;width:min(100%,700px);margin-top:1rem}

    /* Legend / tags */
    .legend{display:flex;flex-wrap:wrap;gap:.5rem;padding:0 .25rem .25rem;margin:0 0 1.25rem 0;list-style:none;}
    .legend .legend-item{display:inline-flex;flex:0 0 auto;padding:.3rem .75rem;border-radius:999px;font-size:.9rem;font-weight:700;border:2px solid;white-space:nowrap;cursor:pointer;user-select:none;transition:transform .1s ease,opacity .2s ease}
    .legend .legend-item:hover{transform:scale(1.05)}
    .legend .legend-item.selected{outline:3px solid rgba(14,165,233,.25)}
    .tag-all{background:#e5e7eb;border-color:#94a3b8;color:#334155}
    .category-tag{padding:.3rem .75rem;border-radius:999px;font-size:.9rem;font-weight:700;border:2px solid;white-space:nowrap;user-select:none}

    .topic-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1.25rem}
    .word-card{border:2px solid #cbd5e1;border-radius:12px;background:#fff;box-shadow:0 4px 6px rgba(0,0,0,.03);overflow:hidden;transition:transform .2s,box-shadow .2s}
    .word-card.hidden{display:none}
    .word-card:hover{transform:translateY(-5px);box-shadow:0 8px 15px rgba(0,0,0,.07)}

    .card-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;background:#f1f5f9;border-bottom:2px solid #e2e8f0}
    .card-title{display:flex;align-items:baseline;gap:.6rem}
    .word-number{font-size:1.3rem;font-weight:700;color:#475569}
    .word-text{font-size:1.9rem;font-weight:800;color:#0f172a}

    .audio-button{font-size:2rem;cursor:pointer;background:none;border:none;padding:0;line-height:1;transition:transform .1s}
    .audio-button:hover{transform:scale(1.1)}
    .audio-button:active{transform:scale(0.95)}

    .card-body{padding:1.1rem; display:flex; flex-direction:column; align-items:center;}
    .badges{display:flex;gap:.5rem;flex-wrap:nowrap;overflow:auto;white-space:nowrap;padding-bottom:.25rem;margin-bottom:.25rem;-webkit-overflow-scrolling:touch}
    .badges .category-tag{flex:0 0 auto}

    .boxes-grid{
      display:grid;
      grid-auto-rows:auto;
      border:2px solid #94a3b8;
      border-radius:8px;
      overflow:auto;
      grid-auto-columns:max-content;
      justify-content:start;
      align-content:start;
      width:max-content;
      max-width:100%;
    }
    .box{
      display:flex;align-items:center;justify-content:center;
      min-height:56px;padding:.35rem .5rem;text-align:center;
      font-size:1.6rem;font-weight:700;border-right:2px solid #cbd5e1;
    }
    .box:last-child{border-right:none}
    .grapheme-box{background:#f1f5f9;color:#1e293b;position:relative;font-family:'Inter','Noto Sans TC',sans-serif;border-bottom:2px solid #cbd5e1;grid-row:1}

    .phoneme-box{
      background:#fff;
      font-family:'Noto Sans','Noto Sans TC',sans-serif !important;
      font-size:1.6rem !important;
      font-weight:400 !important;
      color:#0f172a;
      grid-row:2;transition:.2s;cursor:pointer;user-select:none;
      line-height:1.4;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    .phoneme-box.is-phonics{
      font-family:'Noto Sans','Noto Sans TC',sans-serif !important;
      font-size:1.6rem !important;
      font-weight:400 !important;
      line-height:1.4;
      -webkit-font-smoothing: antialiased;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    .phoneme-box:hover{background:#f0f9ff;transform:none}
    .phoneme-box:active{background:#dbeafe}

    .phoneme-box, .audio-button {
      -webkit-tap-highlight-color: rgba(59, 130, 246, 0.1);
      touch-action: manipulation;
    }

    .heart-symbol{position:absolute;bottom:-2px;left:0;right:0;text-align:center;color:#ef4444;font-size:1rem;line-height:1}
    .word-tips{
      background:#fef3c7;border:1px solid #fbbf24;border-radius:6px;
      padding:.5rem .75rem;margin-top:.8rem;font-family:'Noto Sans TC',sans-serif;
      color:#78350f;font-size:1.05rem;line-height:1.5;display:flex;gap:.5rem;align-items:flex-start
    }
    .tips-icon{color:#f59e0b;font-size:1.1rem}

    .toggle-container{display:flex;justify-content:center;align-items:center;gap:1rem;margin-bottom:.4rem;font-weight:700;color:#334155;user-select:none;font-size:1rem}
    .attribution-note{text-align:center;font-size:.85rem;color:#64748b;margin-top:0;margin-bottom:1.1rem;line-height:1.5}
    .attribution-note a{color:#3b82f6;text-decoration:underline}
    .attribution-note a:hover{color:#1d4ed8}
    .toggle-label-ipa,.toggle-label-phonics{color:#64748b;transition:color .2s}
    input:checked ~ .toggle-label-phonics{color:#0f172a}
    input:not(:checked) ~ .toggle-label-ipa{color:#0f172a}
    .switch{position:relative;display:inline-block;width:60px;height:34px;visibility:hidden}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#cbd5e1;transition:.4s;border-radius:34px;visibility:visible}
    .slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background:white;transition:.4s;border-radius:50%}
    input:checked + .slider{background:#3b82f6}
    input:checked + .slider:before{transform:translateX(26px)}

    .credits{margin-top:3rem;padding-top:1.2rem;border-top:2px solid var(--c-border);text-align:center;font-size:.875rem;color:#475569;line-height:1.6}
    .credits a{color:#64748b;margin:0 .5rem;transition:color .2s;text-decoration:none}
    .credits a:hover{color:#3b82f6}

    .searchbar{display:flex;gap:.5rem;align-items:center;justify-content:center;margin:-.3rem auto 1rem;max-width:700px}
    .searchbar input{flex:1;padding:12px 14px;border:2px solid var(--c-border);border-radius:10px;font-size:1.15rem}
    .searchbar button{background:#e1effa;color:#0f172a;border:none;border-radius:10px;padding: 12px 18px; font-size: 1.15rem; font-weight:500;cursor:pointer}

    .searchbar button:hover{opacity:.9}
    .search-msg{margin:.25rem 0 1rem;text-align:center;font-size:.9rem;color:#64748b}

    u { text-underline-offset: .15em; text-decoration-thickness: from-font; }

    .word-card.search-hit{outline:3px solid #7c3aed;box-shadow:0 0 0 4px rgba(124,58,237,.15);animation:hitflash 1.6s ease}
    @keyframes hitflash{0%{background:#faf5ff}100%{background:#fff}}

    @media (max-width:768px){
      .container{padding:1rem .5rem}
      h1{font-size:1.6rem}
      .topic-grid{grid-template-columns:1fr}
      .word-text{font-size:1.7rem}
      .box{font-size:1.5rem;min-height:52px}
      .phoneme-box{
        font-size:1.5rem !important;
        font-weight:400 !important;
        font-family:'Noto Sans','Noto Sans TC',sans-serif !important;
        line-height:1.4;
        -webkit-font-smoothing: antialiased;
        -webkit-text-size-adjust: 100%;
      }
      .phoneme-box.is-phonics{
        font-size:1.5rem !important;
        font-weight:400 !important;
        font-family:'Noto Sans','Noto Sans TC',sans-serif !important;
        line-height:1.4;
        -webkit-font-smoothing: antialiased;
        -webkit-text-size-adjust: 100%;
      }
      .attribution-note{font-size:.75rem}
      .back-button{margin-bottom:1rem;font-size: 1.1rem; padding:10px 16px}
    }

    .box.phoneme-box span.phoneme-vowel { 
      color:#dc2626 !important; 
      font-family: inherit !important;
      font-size: inherit !important;
      font-weight: inherit !important;
      -webkit-font-smoothing: inherit;
      -moz-osx-font-smoothing: inherit;
    }
    .box.phoneme-box span.phoneme-consonant { 
      color:#2563eb !important; 
      font-family: inherit !important;
      font-size: inherit !important;
      font-weight: inherit !important;
      -webkit-font-smoothing: inherit;
      -moz-osx-font-smoothing: inherit;
    }

    .phoneme-box.loading-audio::after {
      content: 'â³';
      position: absolute;
      top: 2px;
      right: 2px;
      font-size: 0.8rem;
      opacity: 0.5;
    }
    /* ç¸®å°ç¬¬äºŒå±¤ã€Œç´šåˆ¥ã€ä¸‹æ‹‰æ¡†å¯¬åº¦ */
#levelSelect { min-width: 160px; }
.back-button{
  font-size: 1.1rem;    /* è¿”å›ç›®éŒ„ï¼šå­—é«”è®Šå¤§ */
  padding: 10px 16px;   /* èˆ‡å¤–æ¡†é–“è·æ›´å¤§ */
}
    /* è®“ä¸€æ•´æ’æ¨™ç±¤æ’æ»¿å°±æ›åˆ°ä¸‹ä¸€åˆ—ï¼›æ¯é¡†è† å›Šå…§ä¸æ›è¡Œ */
.badges{
  flex-wrap: wrap !important;     /* åŸæœ¬æ˜¯ nowrap â†’ æ”¹æˆ wrap */
  white-space: normal !important; /* å®¹å™¨å…è¨±å¤šåˆ— */
  overflow: visible !important;   /* ä¸è¦å‡ºç¾æ°´å¹³æ²å‹• */
}
.badges .category-tag{
  white-space: nowrap !important; /* å–®ä¸€è† å›Šå…§ä¿æŒå–®è¡Œ */
}
/* --- æ”¯æŒæˆ‘ CTA æŒ‰éˆ•ï¼šè«è˜­è¿ªç´«è—ï¼ˆæ›´äº®ã€å­—æ›´å¤§ï¼‰ --- */
.support-btn{
  display:inline-block;
  background: linear-gradient(90deg, #D9DDF0, #BFCBE6); /* æ›´äº®çš„éœ§ç´«è— */
  color:#ffffff;
  font-weight:500;
  font-size:1.05rem;          /* å­—è®Šå¤§ */
  padding:.65rem 1.35rem;     /* è·Ÿè‘—åŠ å¤§é–“è· */
  border-radius:9999px;
  box-shadow:0 6px 14px rgba(0,0,0,.08);
  text-decoration:none;
  transition:transform .15s ease, box-shadow .2s ease, background .2s ease;
}
.support-btn:hover{
  transform:scale(1.06);
  background: linear-gradient(90deg, #CCD2EC, #B1BFE1); /* hover ç•¥æ·±ä¸€éšï¼Œä»ç¶­æŒæŸ”éœ§æ„Ÿ */
}
.support-btn:focus{
  outline:3px solid rgba(160, 175, 215, .45);
  outline-offset:2px;
}



  </style>
</head>

<body>
  <div class="container">
    <main>
      <div class="searchbar" role="search">
        <input id="globalSearchInput" type="text" placeholder="è¼¸å…¥å–®å­—ï¼ˆä¾‹å¦‚ï¼šoneï¼‰" aria-label="æœå°‹å–®å­—">
        <button id="globalSearchBtn">ğŸ” æœå°‹</button>
      </div>
      <p id="searchMsg" class="search-msg" aria-live="polite"></p>

      <section id="homePage" class="page-section active">
        <h1>è‹±æ–‡æ‹¼å­— Ã— è²éŸ³å°ç…§<br>Word Mapper</h1>
        <ul id="topicList" class="topic-list"></ul>
      </section>
      <!-- å…§å®¹é æœƒå‹•æ…‹åŠ å…¥ -->
    </main>

    <footer class="credits">
      Â© 2025 Christina Yu. All rights reserved.<br /><br />
        <!-- æ–°å¢ï¼šè´ŠåŠ©æŒ‰éˆ• -->
  <div class="support-cta">
    <a href="https://portaly.cc/mamahowma/support"
       target="_blank" rel="noopener noreferrer"
       class="support-btn">
      æ”¯æŒæˆ‘ç¹¼çºŒå‰µä½œåˆ†äº«ï¼Œè«‹æˆ‘å–æ¯å’–å•¡å§ â˜•
    </a>
  </div>

  <br />
      <a href="mailto:mamahowma@gmail.com" aria-label="Email mamahowma">
        <i class="fa-solid fa-envelope fa-xl fa-fw" aria-hidden="true"></i>
      </a>&emsp;
      <a href="https://www.facebook.com/mamahowma" target="_blank" rel="noopener noreferrer" aria-label="mamahowma Facebook Page">
        <i class="fa-brands fa-facebook fa-xl fa-fw" aria-hidden="true"></i>
      </a>&emsp;
      <a href="https://portaly.cc/mamahowma/support" target="_blank" rel="noopener noreferrer" aria-label="Support mamahowma">
        <i class="fa-solid fa-mug-hot fa-xl fa-fw" aria-hidden="true"></i>
      </a>
    </footer>
  </div>

  <script>
    // ================== å…¨åŸŸé–‹é—œ & è‡ªå‹•èª¿æ•´ ==================
    const DISABLE_PREFETCH = false;

    const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    const IS_SAVE_DATA = !!(conn && conn.saveData);
    const EFFECTIVE_TYPE = (conn && conn.effectiveType) || '';
    const IS_SLOW_NET = /^(2g|slow-2g)$/i.test(EFFECTIVE_TYPE);
    const IS_TOUCH = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    const IS_IOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

    const PREFETCH_PHONEMES = (IS_SAVE_DATA || IS_SLOW_NET) ? 12 : (IS_IOS ? 30 : 40);
    const PREFETCH_WORDS   = (IS_SAVE_DATA || IS_SLOW_NET) ? 3  : (IS_IOS ? 5 : 8);
    const PREFETCH_CONCURRENCY = IS_IOS ? 4 : 6;

    window.PhonicsApp = window.PhonicsApp || { pendingHighlight: null };

    // ===== utils =====
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text == null ? '' : String(text);
      return div.innerHTML;
    }
    function sanitizePhonemeHtml(text, allowU = true){
      const escaped = escapeHtml(text);
      return allowU
        ? escaped.replace(/&lt;u&gt;/g,'<u>').replace(/&lt;\/u&gt;/g,'</u>')
        : escaped;
    }
    function escapeAttr(val){ return String(val).replace(/&/g,'&amp;').replace(/"/g,'&quot;'); }

    const VOWEL_CHARS = new Set([
      'i','Éª','É›','Ã¦','ÊŒ','É‘','É”','ÊŠ','u','É™','Éš','É',
      'e','a','o','Ä“','Ä«','Å','Ä','Å«','Ä•','Ä­','Å','Å­','Äƒ'
    ]);
    const CONSONANT_CHARS = new Set([
      'p','b','t','d','k','É¡','f','v','Î¸','Ã°','s','z','Êƒ','Ê’','h','m','n','Å‹','l','r','w','j','c','y','x'
    ]);
    const NEUTRAL_CHARS = new Set(['/',' ', "'", 'ËŒ','.', 'Ë','-']);

    function stripColorSpans(html){
      return html
        .replace(/<span[^>]*class="[^"]*\bphoneme-(?:vowel|consonant)\b[^"]*"[^>]*>/gi,'')
        .replace(/<\/span>/gi,'');
    }
    function colorizePhonemes(html){
      if(!html) return '';
      const src = stripColorSpans(html);
      let out = '', i = 0;
      while(i < src.length){
        const ch = src[i];
        if(ch === '<'){
          const j = src.indexOf('>', i);
          if(j === -1){ out += ch; i++; continue; }
          out += src.slice(i, j+1);
          i = j + 1;
          continue;
        }
        if(NEUTRAL_CHARS.has(ch)){ out += ch; i++; continue; }
        if(VOWEL_CHARS.has(ch)){
          out += `<span class="phoneme-vowel">${ch}</span>`;
        }else if(CONSONANT_CHARS.has(ch)){
          out += `<span class="phoneme-consonant">${ch}</span>`;
        }else{
          out += ch;
        }
        i++;
      }
      return out;
    }

    // â€”â€” ä¸­æ–‡æ¨™ç±¤åç¨± â€”â€” 
    const tagNames = {
      all: "å…¨éƒ¨",
      irregular: "ä¸è¦å‰‡æ‹¼å¯«",
      closed: "é–‰éŸ³ç¯€ï¼ˆçŸ­æ¯éŸ³ï¼‰",
      floss: "é‡è¤‡å­éŸ³å­—å°¾ (FLOSS-Z)",
      digraph: "é›™å­—æ¯å­éŸ³",
      cluster: "å­éŸ³ç¾¤",
      suffix: "å­—å°¾å¾Œç¶´",
      rcontrolled: "æ¯éŸ³ + 'r'",
      open: "é–‹éŸ³ç¯€ï¼ˆé•·æ¯éŸ³ï¼‰",
      cle: "å­éŸ³ + 'le'",
      magic_e: "é•·æ¯éŸ³ + éœéŸ³ 'e'",
      vowel_team: "æ¯éŸ³çµ„åˆ",

      silent_consonant: "ä¸ç™¼éŸ³å­éŸ³å­—æ¯",
      cvc: "å–®ä¸€é–‰éŸ³ç¯€ï¼ˆçŸ­æ¯éŸ³ï¼‰"  
    };

    // ====== åŸºæœ¬ç‹€æ…‹ ======
    const TOPICS_URL = 'topics.json';
    const CACHE = { topics: null, data: {} };
    const loadingState = new Set();

    // ====== fetch timeout ======
    function fetchWithTimeout(url, opts={}, timeout=8000){
      return Promise.race([
        fetch(url, opts),
        new Promise((_, rej)=> setTimeout(()=>rej(new Error('Timeout')), timeout))
      ]);
    }

    // ====== éŸ³è¨Šæ’­æ”¾èˆ‡è·¯å¾‘ ======
    const AUDIO_BASE = './audio/';
    let levelFolder = '';

    function audioUrlForWord(item){
      if (item.audio) return item.audio;
      const safeName = String(item.word||'').toLowerCase().replace(/\s+/g, "_");
      return `${AUDIO_BASE}${levelFolder}/${safeName}.mp3`;
    }

    // ====== éŸ³æª”å¿«å– ======
    const AUDIO_CACHE = new Map();
    const CACHE_MAX = 300;
    function cachePut(url, blobUrl){
      AUDIO_CACHE.set(url, { blobUrl, t: Date.now() });
      if (AUDIO_CACHE.size > CACHE_MAX){
        let oldestKey=null, oldestT=Infinity;
        for (const [k,v] of AUDIO_CACHE){
          if (v.t < oldestT){ oldestT=v.t; oldestKey=k; }
        }
        if (oldestKey){
          try{ URL.revokeObjectURL(AUDIO_CACHE.get(oldestKey).blobUrl); }catch{}
          AUDIO_CACHE.delete(oldestKey);
        }
      }
    }
    function cacheGet(url){
      const hit = AUDIO_CACHE.get(url);
      if (hit){ hit.t = Date.now(); return hit.blobUrl; }
      return null;
    }
    async function ensureAudio(url){
      if (!url) return null;
      const hit = cacheGet(url);
      if (hit) return hit;
      const r = await fetchWithTimeout(url, {}, 12000);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const blob = await r.blob();
      const blobUrl = URL.createObjectURL(blob);
      cachePut(url, blobUrl);
      return blobUrl;
    }
    async function batchPrefetch(urls, concurrency = 6) {
      const urlArray = Array.from(urls);
      for (let i = 0; i < urlArray.length; i += concurrency) {
        const batch = urlArray.slice(i, i + concurrency);
        await Promise.all(batch.map(url => ensureAudio(url).catch(()=>null)));
      }
    }
    async function playAudioSmart(url, btn){
      try{
        const src = await ensureAudio(url);
        if (!src) return;
        const p = new Audio();
        p.preload = 'auto';
        p.src = src;
        p.load();
        const playPromise = p.play();
        if (playPromise !== undefined) await playPromise;
      }catch(e){
        if(btn){ 
          const o=btn.textContent || btn.innerHTML; 
          btn.textContent='âŒ'; 
          setTimeout(()=>{ if(typeof o === 'string') btn.textContent=o; else btn.innerHTML=o; },800); 
        }
        console.warn('æ’­æ”¾å¤±æ•—ï¼š', url, e);
      }
    }

    // ====== éŸ³ç´ å°ç…§éŸ³æª”è¡¨ ======
    let PHONEME = { files: {} };
    fetchWithTimeout('data/phoneme-audio.json')
      .then(r => r.ok ? r.json() : {files:{}})
      .then(j => { PHONEME = j || {files:{}}; })
      .catch(()=>{});

    function phonemeUrl(raw){
      if (PHONEME.files && PHONEME.files[raw]) return PHONEME.files[raw];
      const key = String(raw)
        .replace(/<[^>]+>/g,'')
        .replace(/'/g,'')
        .trim()
        .replace(/^\/|\/$/g,'')
        .replace(/\s+/g,'');
      return (PHONEME.files && PHONEME.files[key]) ? PHONEME.files[key] : null;
    }

    // ====== å§”æ´¾äº‹ä»¶ ======
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.audio-button');
      if(btn){
        const url = btn.getAttribute('data-audio-url');
        if(url) playAudioSmart(url, btn);
        return;
      }
      const cell = e.target.closest('.phoneme-box');
      if(cell){
        const raw = cell.textContent;
        const url = phonemeUrl(raw);
        if(!url){ cell.style.background='#fee2e2'; setTimeout(()=>cell.style.background='',400); return; }
        playAudioSmart(url, cell);
        return;
      }
      const nav = e.target.closest('[data-page-target]');
      if(nav){ showPage(nav.getAttribute('data-page-target')); return; }
      const retry = e.target.closest('[data-action="reload"]');
      if(retry){ location.reload(); }
    });

    // é æŠ“
    function setupAudioPrefetchListeners(){
      if (DISABLE_PREFETCH) return;
      if (!IS_TOUCH) {
        document.addEventListener('mouseenter', (e)=>{
          const btn = e.target.closest('.audio-button'); 
          if(btn){ const url = btn.getAttribute('data-audio-url'); if(url) ensureAudio(url).catch(()=>{}); return; }
          const cell = e.target.closest('.phoneme-box');
          if(cell){ const raw = cell.textContent; const url = phonemeUrl(raw); if(url) ensureAudio(url).catch(()=>{}); }
        }, true);
      }
      document.addEventListener('touchstart', (e)=>{
        const btn = e.target.closest('.audio-button'); 
        if(btn){ const url = btn.getAttribute('data-audio-url'); if(url) ensureAudio(url).catch(()=>{}); return; }
        const cell = e.target.closest('.phoneme-box');
        if(cell){ const raw = cell.textContent; const url = phonemeUrl(raw); if(url) ensureAudio(url).catch(()=>{}); }
      }, { passive:true });
    }
    setupAudioPrefetchListeners();

    // ====== ç‹€æ…‹èˆ‡æ¸²æŸ“ ======
    let selectedFilter = 'all'; // â† æ”¹1ï¼šåˆå§‹åŒ–ä¸è®€ sessionStorageï¼Œé è¨­ã€Œå…¨éƒ¨ã€
    let currentTopicData=[];
    let isPhonicsMode=false;

    function initTopicPage(contentId){
      const cnt=document.getElementById(contentId);
      if(!cnt) return;

      const allTags=['all','cvc','closed','open','magic_e','vowel_team','rcontrolled','cle','floss','digraph','cluster','suffix','silent_consonant','irregular'];
      const usedTags=new Set(['all']);
      currentTopicData.forEach(w=>{ (w.tags||[]).forEach(t=>usedTags.add(t)); });
      const existing=allTags.filter(t=>usedTags.has(t));

      let legendHTML='<ul class="legend">';
      existing.forEach(t=>{
        const name = tagNames[t] || t;
        const cls=(t==='all')?'tag-all':`tag-${t}`;
        const sel=(t===selectedFilter)?'selected':'';
        legendHTML+=`<li class="legend-item ${cls} ${sel}" data-filter="${t}">${name}</li>`;
      });
      legendHTML+='</ul>';

      const toggleHTML=`
        <div class="toggle-container">
          <span class="toggle-label-ipa">IPA éŸ³æ¨™</span>
          <label class="switch">
            <input type="checkbox" id="toggle_${contentId}" ${isPhonicsMode?'checked':''}>
            <span class="slider"></span>
          </label>
          <span class="toggle-label-phonics">Phonics æ‹¼éŸ³</span>
        </div>
        <p class="attribution-note">
          IPA æ ¹æ“š<a href="https://christinayu_english.rakosell.com/zh/page/american-ipa-guide" target="_blank">ç¾å¼è‹±èª IPA åœ‹éš›éŸ³æ¨™æŒ‡å—</a><br>
          Phonics æ ¹æ“š <a href="https://ufli.education.ufl.edu/wp-content/uploads/2023/09/UFLI-Sound-Wall-rev.pdf" target="_blank">UFLI phonemes</a>
        </p>
      `;

      cnt.innerHTML=legendHTML+toggleHTML+`<div class="topic-grid" id="teaching-grid-${contentId}"></div>`;

      cnt.querySelectorAll('.legend-item').forEach(li=>{
        li.addEventListener('click',()=>{
          selectedFilter = li.getAttribute('data-filter')||'all';
          // â† æ”¹2ï¼šä¸å†æŒä¹…åŒ–åˆ° sessionStorage
          cnt.querySelectorAll('.legend-item').forEach(x=>x.classList.remove('selected'));
          li.classList.add('selected');
          applyFilters(contentId);
        });
      });

      const tog=cnt.querySelector(`#toggle_${contentId}`);
      if(tog){ tog.addEventListener('change',()=>{ isPhonicsMode=tog.checked; renderCards(contentId); }); }

      renderCards(contentId);
      highlightIfPending(contentId);

      if (!DISABLE_PREFETCH){
        setTimeout(async ()=>{ 
          try{
            const grid = document.getElementById(`teaching-grid-${contentId}`);
            if(!grid) return;
            const urls = new Set();
            grid.querySelectorAll('.phoneme-box').forEach(cell=>{
              const raw = cell.textContent;
              const u = phonemeUrl(raw);
              if(u) urls.add(u);
            });
            await batchPrefetch(urls, PREFETCH_CONCURRENCY);
          }catch(e){ console.warn('Prefetch error:', e); }
        }, 100);
      }
    }

    function renderCards(contentId){
      const grid = document.getElementById(`teaching-grid-${contentId}`);
      if(!grid) return;
      grid.innerHTML='';
      currentTopicData.forEach(w=>{
        const tagsAttr = (w.tags||[]).join(',');
        const badges = (w.tags||[]).map(t => `<span class="category-tag tag-${t}">${escapeHtml(tagNames[t] || t)}</span>`).join('');

        const modeKey = isPhonicsMode?'phonics':'phonemes';
        const useArr = (w[modeKey]||w.phonemes||[]);
        const labelArr = (w.graphemes||[]);
        const heartArr = (w.hearts||[]);

        const cols = Math.max(labelArr.length, useArr.length);
        let cells='';
        for(let i=0;i<cols;i++){
          const g = labelArr[i]||'';
          const p = useArr[i]||'';
          const heart = heartArr[i]?'<span class="heart-symbol">â¤</span>':'';
          const phClass = (isPhonicsMode)?'is-phonics':'';
          const pHtmlRaw = isPhonicsMode ? sanitizePhonemeHtml(p, true) : escapeHtml(p);
          const pHtml = colorizePhonemes(pHtmlRaw);
          cells+=`
            <div class="grapheme-box box">${escapeHtml(g)}${heart}</div>
            <div class="phoneme-box box ${phClass}">${pHtml}</div>
          `;
        }

        const audioURL = audioUrlForWord(w);
        const card=`
          <article class="word-card" data-tags="${escapeAttr(tagsAttr)}" data-word="${escapeAttr(String(w.word||'').toLowerCase())}">
            <div class="card-header">
              <div class="card-title">
<span class="word-text">${escapeHtml(w.word||'')}</span>
<span class="word-number">${escapeHtml(w.number ?? '')}</span>
              </div>
              <button class="audio-button" data-audio-url="${escapeAttr(audioURL)}" aria-label="æ’­æ”¾å–®å­—ç™¼éŸ³">ğŸ”Š</button>
            </div>
            <div class="card-body">
              <div class="badges">${badges}</div>
              <div class="boxes-grid" style="grid-template-columns:repeat(${cols},max-content)">${cells}</div>
              <div class="word-tips"><span class="tips-icon">ğŸ’¡</span><span>${escapeHtml(w.hint||'')}</span></div>
            </div>
          </article>
        `;
        grid.insertAdjacentHTML('beforeend',card);
      });
      applyFilters(contentId);

      if (!DISABLE_PREFETCH){
        try{
          const warm = (currentTopicData||[]).slice(0, PREFETCH_WORDS).map(w => audioUrlForWord(w)).filter(Boolean);
          warm.forEach(u=>{ ensureAudio(u).catch(()=>{}); });
        }catch(e){}
      }
    }

    function applyFilters(contentId){
      const grid = document.getElementById(`teaching-grid-${contentId}`);
      if(!grid) return;
      const cards = grid.querySelectorAll('.word-card');
      if(selectedFilter === 'all'){ cards.forEach(c=>c.classList.remove('hidden')); return; }
      cards.forEach(c=>{
        const tags = (c.getAttribute('data-tags')||'').split(',').filter(Boolean);
        c.classList.toggle('hidden', !tags.includes(selectedFilter));
      });
    }

    // ====== æœå°‹ ======
    let WORD_INDEX = {};
    function buildWordIndexFromAll(){
      WORD_INDEX = {};
      (CACHE.topics?.topics||[]).forEach(t=>{
        t.levels.forEach((lv, idx)=>{
          const items = CACHE.data[lv.src]?.items || [];
          items.forEach(w=>{
            const key = String(w.word||'').trim().toLowerCase();
            if(key && !WORD_INDEX[key]) WORD_INDEX[key] = { slug: t.slug, levelIndex: idx };
          });
        });
      });
    }
    function goToWord(wordRaw){
      const input = String(wordRaw||'').trim().toLowerCase();
      const msgEl = document.getElementById('searchMsg');
      if(!input){ msgEl.textContent='è«‹è¼¸å…¥å–®å­—'; return; }
      const hit = WORD_INDEX[input];
      if(!hit){ msgEl.textContent=`æ‰¾ä¸åˆ°ï¼š${wordRaw}`; return; }
      msgEl.textContent='';
      const pageId = `${hit.slug}_${hit.levelIndex+1}_Page`;
      window.PhonicsApp.pendingHighlight = input;
      showPage(pageId);
    }
    function initSearchBar(){
      const inp=document.getElementById('globalSearchInput');
      const btn=document.getElementById('globalSearchBtn');
      if(!inp||!btn) return;
      btn.addEventListener('click',()=>goToWord(inp.value));
      inp.addEventListener('keydown',(e)=>{ if(e.key==='Enter') goToWord(inp.value); });
    }
    function highlightIfPending(contentId){
      const target=(window.PhonicsApp.pendingHighlight||'').toLowerCase();
      if(!target) return;
      const grid=document.getElementById(`teaching-grid-${contentId}`);
      if(!grid) return;
      const escaped = (window.CSS && CSS.escape) ? CSS.escape(target)
        : target.replace(/[!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, "\\$&");
      const card=grid.querySelector(`.word-card[data-word="${escaped}"]`);
      if(card){
        card.classList.add('search-hit');
        card.scrollIntoView({behavior:'smooth',block:'center'});
        setTimeout(()=>card.classList.remove('search-hit'),1600);
      }
      window.PhonicsApp.pendingHighlight='';
    }

    // ====== å°èˆªï¼ˆä¾ topics.json å‹•æ…‹ç”Ÿæˆï¼‰ ======
    function showPage(pageId){
      selectedFilter = 'all'; // â† æ”¹3ï¼šåˆ‡æ›é é¢æ™‚å¼·åˆ¶é‡ç½®ç¯©é¸ç‚ºã€Œå…¨éƒ¨ã€
      document.querySelectorAll('.page-section').forEach(p=>p.classList.remove('active'));
      const active = document.getElementById(pageId);
      if(!active) return;
      active.classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });

      const m = pageId.match(/^(.+?)_(\d+)_Page$/);
      if(!m) return; // home
      const slug = m[1], levelIndex = Number(m[2])-1;
      const contentId = `${slug}_${levelIndex+1}_Content`;

      const topic = (CACHE.topics?.topics||[]).find(x=>x.slug===slug);
      const lv = topic?.levels?.[levelIndex];
      if(!lv) return;

      levelFolder = (lv.src||'').replace(/^data\//,'').replace(/\.json$/,'').replace(/^\//,'');

      if(!CACHE.data[lv.src] && !loadingState.has(lv.src)){
        const t = document.getElementById(contentId);
        if (t) t.innerHTML = '<p style="color:#666">è¼‰å…¥ä¸­â€¦</p>';
        loadingState.add(lv.src);
        fetchWithTimeout(lv.src)
          .then(r=>{ if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
          .then(json=>{
            CACHE.data[lv.src]=json; loadingState.delete(lv.src);
            if(document.getElementById(pageId)?.classList.contains('active')){
              currentTopicData = json.items||[];
              initTopicPage(contentId);
            }
          })
          .catch(e=>{
            loadingState.delete(lv.src);
            const t=document.getElementById(contentId);
            if(t) t.innerHTML = `<p style="color:#b91c1c">è¼‰å…¥å¤±æ•—ï¼š${escapeHtml(lv.src)}ï¼ˆ${escapeHtml(e.message)}ï¼‰ <button data-action="reload">é‡è©¦</button></p>`;
          });
      }else if(CACHE.data[lv.src]){
        currentTopicData = CACHE.data[lv.src].items||[];
        initTopicPage(contentId);
      }
    }
    window.PhonicsApp.showPage = showPage;

    // ====== å…©å±¤ä¸‹æ‹‰ï¼šå»ºæ§‹é¦–é èˆ‡ sections ======
    function buildHomeAndSections(){
      const list = document.getElementById('topicList');
      const main = document.querySelector('main');

      list.innerHTML = `
        <div class="dropdown-container">
          <div class="dropdown-row">
            <label for="topicSelect">ä¸»é¡Œï¼š</label>
            <select id="topicSelect" class="dropdown-select">
              <option value="">è«‹é¸æ“‡ä¸»é¡Œ</option>
            </select>
          </div>
          <div class="dropdown-row">
            <label for="levelSelect">ç´šåˆ¥ï¼š</label>
            <select id="levelSelect" class="dropdown-select" disabled>
              <option value="">è«‹å…ˆé¸ä¸»é¡Œ</option>
            </select>
            <button id="enterBtn" class="dropdown-btn">é¸æ“‡</button>
          </div>
        </div>
      `;

      const topicSelect = document.getElementById('topicSelect');
      const levelSelect = document.getElementById('levelSelect');
      const enterBtn = document.getElementById('enterBtn');

      (CACHE.topics?.topics||[]).forEach(t=>{
        const opt=document.createElement('option');
        opt.value=t.slug;
        opt.textContent=t.title;
        topicSelect.appendChild(opt);

        t.levels.forEach((lv, idx)=>{
          const label = lv.label || `-${idx+1}`;
          main.insertAdjacentHTML('beforeend', `
            <section id="${t.slug}_${idx+1}_Page" class="page-section">
              <button class="back-button" data-page-target="homePage"><i class="fa-solid fa-arrow-left"></i>è¿”å›ç›®éŒ„</button>
              <h1>${escapeHtml(t.title)}ï¼ˆ${escapeHtml(label)}ï¼‰</h1>
              <div id="${t.slug}_${idx+1}_Content"></div>
            </section>
          `);
        });
      });

      topicSelect.addEventListener('change',()=>{
        const slug=topicSelect.value;
        levelSelect.innerHTML='';
        if(!slug){
          levelSelect.disabled=true;
          levelSelect.innerHTML='<option value="">è«‹å…ˆé¸ä¸»é¡Œ</option>';
          return;
        }
        const topic=(CACHE.topics?.topics||[]).find(t=>t.slug===slug);
        if(!topic){return;}
        topic.levels.forEach((lv,idx)=>{
          const opt=document.createElement('option');
          opt.value=`${slug}_${idx+1}_Page`;
          opt.textContent=lv.label || `Level ${idx+1}`;
          levelSelect.appendChild(opt);
        });
        levelSelect.disabled=false;
      });

      enterBtn.addEventListener('click',()=>{
        const val=levelSelect.value;
        if(!val){alert('è«‹é¸æ“‡ç´šåˆ¥');return;}
        showPage(val);
      });
    }

    // ====== å•Ÿå‹• ======
    document.addEventListener('DOMContentLoaded', async ()=>{
      initSearchBar();
      try{
        const resp = await fetchWithTimeout(TOPICS_URL);
        if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
        CACHE.topics = await resp.json();
      }catch(e){
        console.error(e);
        document.getElementById('topicList').innerHTML =
          `<li class="topic-list-item" style="color:#b91c1c">
            è®€å– topics.json å¤±æ•—ï¼ˆ${escapeHtml(e.message)}ï¼‰
            <button data-action="reload" style="margin-left:.5rem">é‡è©¦</button>
          </li>`;
        return;
      }
      buildHomeAndSections();

      await Promise.allSettled(
        (CACHE.topics.topics||[]).flatMap(t => t.levels.map(lv =>
          fetchWithTimeout(lv.src).then(r=>r.ok?r.json():null).then(j=>{ if(j) CACHE.data[lv.src]=j; })
        ))
      );
      buildWordIndexFromAll();

      document.querySelectorAll('.page-section').forEach(p=>p.classList.remove('active'));
      document.getElementById('homePage').classList.add('active');
    });
  </script>
</body>
</html>
