<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no"/>
  <title>英文拼字 × 聲音對照</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&family=Noto+Sans:wght@400;700&family=Noto+Sans+TC:wght@400;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root{ --c-primary:#7c3aed; --c-secondary:#10b981; --c-text:#1f2937; --c-bg:#f8fafc; --c-border:#e2e8f0; }

    /* tag 類別色 */
    .tag-irregular{background:#fee2e2;border-color:#ef4444;color:#991b1b;}
    .tag-closed{background:#d1fae5;border-color:#10b981;color:#065f46;}
    .tag-floss{background:#ffe4e6;border-color:#fb7185;color:#9f1239;}
    .tag-digraph{background:#e0f2fe;border-color:#38bdf8;color:#075985;}
    .tag-cluster{background:#ede9fe;border-color:#8b5cf6;color:#4c1d95;}
    .tag-suffix{background:#ccfbf1;border-color:#14b8a6;color:#0f766e;}
    .tag-rcontrolled{background:#e9d5ff;border-color:#a855f7;color:#581c87;}
    .tag-open{background:#dcfce7;border-color:#22c55e;color:#14532d;}
    .tag-cle{background:#f5f5f4;border-color:#a8a29e;color:#3f3f46;}
    .tag-magic_e{background:#dbeafe;border-color:#3b82f6;color:#1e40af;}
    .tag-vowel_team{background:#ffedd5;border-color:#f97316;color:#9a3412;}
    .tag-diphthong{background:#dbeafe;border-color:#60a5fa;color:#1e3a8a;}
    .tag-silent_consonant{background:#f1f5f9;border-color:#94a3b8;color:#334155;}

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;overflow-x:hidden}
    body{font-family:"Inter",system-ui,-apple-system,"Noto Sans TC",sans-serif;background:var(--c-bg);color:var(--c-text);padding:1rem 0;line-height:1.6;font-size:18px}
    .container{max-width:1200px;margin:0 auto;padding:1.5rem 1rem;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);min-height:90vh}
    h1{font-family:'Noto Sans TC',sans-serif;font-size:2rem;font-weight:800;color:#0f172a;text-align:center;margin-bottom:2rem}

    /* Page switch */
    .page-section{display:none;min-height:50vh}
    .page-section.active{display:block}
    #homePage{flex-direction:column;align-items:center;justify-content:flex-start}
    #homePage.active{display:flex}
    #homePage:not(.active){display:none!important}

    /* Home list */
    .topic-list{list-style:none;padding:0;width:min(100%,700px);margin-top:2rem}
    .topic-list-item{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.05);padding:18px 22px;cursor:pointer;transition:.2s;border-left:5px solid var(--c-secondary);font-size:1.2rem;font-weight:700;color:#1f2937;margin-bottom:1rem;user-select:none;display:block}
    .topic-list-item:hover{background:#f0fdf4;transform:translateX(5px);box-shadow:0 4px 12px rgba(16,185,129,.2);border-color:var(--c-primary)}

    .back-button{background:#eef2ff;color:#4f46e5;border:none;border-radius:12px;padding:10px 18px;font-weight:700;cursor:pointer;font-size:1rem;margin-bottom:1.2rem;transition:.2s;display:flex;align-items:center;gap:8px}
    .back-button:hover{background:#e0e7ff}

    /* Filters & Cards */
    .legend{display:flex;flex-wrap:wrap;gap:.5rem;padding:0 .25rem .25rem;margin:0 0 1.25rem 0;list-style:none;}
    .legend .legend-item{display:inline-flex;flex:0 0 auto;padding:.3rem .75rem;border-radius:999px;font-size:.9rem;font-weight:700;border:2px solid;white-space:nowrap;cursor:pointer;user-select:none;transition:transform .1s ease,opacity .2s ease}
    .legend .legend-item:hover{transform:scale(1.05)}
    .legend .legend-item.selected{outline:3px solid rgba(14,165,233,.25)}
    .tag-all{background:#e5e7eb;border-color:#94a3b8;color:#334155}
    .category-tag{padding:.3rem .75rem;border-radius:999px;font-size:.9rem;font-weight:700;border:2px solid;white-space:nowrap;user-select:none}

    .topic-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1.25rem}
    .word-card{border:2px solid #cbd5e1;border-radius:12px;background:#fff;box-shadow:0 4px 6px rgba(0,0,0,.03);overflow:hidden;transition:transform .2s,box-shadow .2s}
    .word-card.hidden{display:none}
    .word-card:hover{transform:translateY(-5px);box-shadow:0 8px 15px rgba(0,0,0,.07)}

    .card-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;background:#f1f5f9;border-bottom:2px solid #e2e8f0}
    .card-title{display:flex;align-items:baseline;gap:.6rem}
    .word-number{font-size:1.3rem;font-weight:700;color:#475569} /* 可放 emoji 或文字 */
    .word-text{font-size:1.9rem;font-weight:800;color:#0f172a}

    .audio-button{font-size:2rem;cursor:pointer;background:none;border:none;padding:0;line-height:1;transition:transform .1s}
    .audio-button:hover{transform:scale(1.1)}
    .audio-button:active{transform:scale(0.95)}

    .card-body{padding:1.1rem; display:flex; flex-direction:column; align-items:center;}
    .badges{display:flex;gap:.5rem;flex-wrap:nowrap;overflow:auto;white-space:nowrap;padding-bottom:.25rem;margin-bottom:.25rem;-webkit-overflow-scrolling:touch}
    .badges .category-tag{flex:0 0 auto}

    .boxes-grid{
      display:grid;
      grid-auto-rows:auto;
      border:2px solid #94a3b8;
      border-radius:8px;
      overflow:auto;
      grid-auto-columns:max-content;
      justify-content:start;
      align-content:start;
      width:max-content;
      max-width:100%;
    }
    /* 表格字體（與單字協調） */
    .box{
      display:flex;align-items:center;justify-content:center;
      min-height:56px;padding:.35rem .5rem;text-align:center;
      font-size:1.6rem;font-weight:700;border-right:2px solid #cbd5e1;
    }
    .box:last-child{border-right:none}
    .grapheme-box{background:#f1f5f9;color:#1e293b;position:relative;font-family:'Inter','Noto Sans TC',sans-serif;border-bottom:2px solid #cbd5e1;grid-row:1}

    /* phoneme/phonics（基礎）—不鎖顏色，讓紅/藍生效 */
    .phoneme-box{
      background:#fff;
      font-family:'Noto Sans','Noto Sans TC',sans-serif;
      font-size:1.6rem;font-weight:400;
      color:#0f172a; /* 基色；單字元會被 span 覆蓋 */
      grid-row:2;transition:.2s;cursor:pointer;user-select:none
    }
    .phoneme-box.is-phonics{font-family:inherit;font-size:inherit;font-weight:inherit;color:inherit}
    .phoneme-box:hover{background:#f0f9ff;transform:none}
    .phoneme-box:active{background:#dbeafe}

    .heart-symbol{position:absolute;bottom:-2px;left:0;right:0;text-align:center;color:#ef4444;font-size:1rem;line-height:1}
    .word-tips{
      background:#fef3c7;border:1px solid #fbbf24;border-radius:6px;
      padding:.5rem .75rem;margin-top:.8rem;font-family:'Noto Sans TC',sans-serif;
      color:#78350f;font-size:1.05rem;line-height:1.5;display:flex;gap:.5rem;align-items:flex-start
    }
    .tips-icon{color:#f59e0b;font-size:1.1rem}

    .toggle-container{display:flex;justify-content:center;align-items:center;gap:1rem;margin-bottom:.4rem;font-weight:700;color:#334155;user-select:none;font-size:1rem}
    .attribution-note{text-align:center;font-size:.85rem;color:#64748b;margin-top:0;margin-bottom:1.1rem;line-height:1.5}
    .attribution-note a{color:#3b82f6;text-decoration:underline}
    .attribution-note a:hover{color:#1d4ed8}
    .toggle-label-ipa,.toggle-label-phonics{color:#64748b;transition:color .2s}
    input:checked ~ .toggle-label-phonics{color:#0f172a}
    input:not(:checked) ~ .toggle-label-ipa{color:#0f172a}
    .switch{position:relative;display:inline-block;width:60px;height:34px;visibility:hidden}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#cbd5e1;transition:.4s;border-radius:34px;visibility:visible}
    .slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background:white;transition:.4s;border-radius:50%}
    input:checked + .slider{background:#3b82f6}
    input:checked + .slider:before{transform:translateX(26px)}

    .credits{margin-top:3rem;padding-top:1.2rem;border-top:2px solid var(--c-border);text-align:center;font-size:.875rem;color:#475569;line-height:1.6}
    .credits a{color:#64748b;margin:0 .5rem;transition:color .2s;text-decoration:none}
    .credits a:hover{color:#3b82f6}

    .searchbar{display:flex;gap:.5rem;align-items:center;justify-content:center;margin:-.3rem auto 1rem;max-width:700px}
    .searchbar input{flex:1;padding:10px 12px;border:2px solid var(--c-border);border-radius:10px;font-size:1rem}
    .searchbar button{background:#111827;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .searchbar button:hover{opacity:.9}
    .search-msg{margin:.25rem 0 1rem;text-align:center;font-size:.9rem;color:#64748b}

    /* 可讀性更好的底線 */
    u { text-underline-offset: .15em; text-decoration-thickness: from-font; }

    .word-card.search-hit{outline:3px solid #7c3aed;box-shadow:0 0 0 4px rgba(124,58,237,.15);animation:hitflash 1.6s ease}
    @keyframes hitflash{0%{background:#faf5ff}100%{background:#fff}}

    @media (max-width:768px){
      .container{padding:1rem .5rem}
      h1{font-size:1.6rem}
      .topic-list{width:100%}
      .topic-list-item{font-size:1.05rem;padding:14px 16px}
      .topic-grid{grid-template-columns:1fr}
      .word-text{font-size:1.7rem}
      .box{font-size:1.5rem;min-height:52px}
      .phoneme-box{font-size:1.5rem;font-weight:400;font-family:'Noto Sans','Noto Sans TC',sans-serif}
      .phoneme-box.is-phonics{font-size:inherit;font-weight:inherit;font-family:inherit}
      .attribution-note{font-size:.75rem}
      .back-button{margin-bottom:1rem;padding:8px 14px}
    }

    /* —— 單字元著色（放在檔案最末，覆蓋任何先前規則） —— */
    .box.phoneme-box span.phoneme-vowel { color:#dc2626 !important; }     /* 紅 */
    .box.phoneme-box span.phoneme-consonant { color:#2563eb !important; } /* 藍 */
  </style>
</head>

<body>
  <div class="container">
    <main>
      <div class="searchbar" role="search">
        <input id="globalSearchInput" type="text" placeholder="輸入單字（例如：one）" aria-label="搜尋單字">
        <button id="globalSearchBtn">🔍 搜尋</button>
      </div>
      <p id="searchMsg" class="search-msg" aria-live="polite"></p>

      <section id="homePage" class="page-section active">
        <h1>英文拼字 × 聲音對照</h1>
        <ul id="topicList" class="topic-list"></ul>
      </section>
      <!-- 內容頁會動態加入 -->
    </main>

    <footer class="credits">
      © 2025 Christina Yu. All rights reserved.<br /><br />
      <a href="mailto:mamahowma@gmail.com" aria-label="Email mamahowma">
        <i class="fa-solid fa-envelope fa-xl fa-fw" aria-hidden="true"></i>
      </a>&emsp;
      <a href="https://www.facebook.com/mamahowma" target="_blank" rel="noopener noreferrer" aria-label="mamahowma Facebook Page">
        <i class="fa-brands fa-facebook fa-xl fa-fw" aria-hidden="true"></i>
      </a>&emsp;
      <a href="https://portaly.cc/mamahowma/support" target="_blank" rel="noopener noreferrer" aria-label="Support mamahowma">
        <i class="fa-solid fa-mug-hot fa-xl fa-fw" aria-hidden="true"></i>
      </a>
    </footer>
  </div>

  <script>
    // ================== 全域開關 & 自動調整 ==================
    const DISABLE_PREFETCH = false; // 設為 true 可一鍵關閉所有預載

    const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    const IS_SAVE_DATA = !!(conn && conn.saveData);
    const EFFECTIVE_TYPE = (conn && conn.effectiveType) || '';
    const IS_SLOW_NET = /^(2g|slow-2g)$/i.test(EFFECTIVE_TYPE);
    const IS_TOUCH = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

    // 依網路狀況調整預載量
    const PREFETCH_PHONEMES = (IS_SAVE_DATA || IS_SLOW_NET) ? 12 : 40;
    const PREFETCH_WORDS   = (IS_SAVE_DATA || IS_SLOW_NET) ? 3  : 8;

    // 命名空間
    window.PhonicsApp = window.PhonicsApp || { pendingHighlight: null };

    // ========== 工具：HTML 轉義 / 允許 <u> ==========
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text == null ? '' : String(text);
      return div.innerHTML;
    }
    function sanitizePhonemeHtml(text, allowU = true){
      const escaped = escapeHtml(text);
      return allowU
        ? escaped.replace(/&lt;u&gt;/g,'<u>').replace(/&lt;\/u&gt;/g,'</u>')
        : escaped;
    }
    function escapeAttr(val){ return String(val).replace(/&/g,'&amp;').replace(/"/g,'&quot;'); }

    // ========== 單字元紅/藍著色（僅使用你檔案中的實際符號） ==========
    const VOWEL_CHARS = new Set([
      'i','ɪ','ɛ','æ','ʌ','ɑ','ɔ','ʊ','u','ə','ɚ','ɝ',
      'e','a','o','ē','ī','ō','ā','ū','ĕ','ĭ','ŏ','ŭ','ă'
    ]);
    const CONSONANT_CHARS = new Set([
      'p','b','t','d','k','g','f','v','θ','ð','s','z','ʃ','ʒ','h','m','n','ŋ','l','r','w','j','c','y','x'
    ]);
    const NEUTRAL_CHARS = new Set(['/',' ', "'", 'ˌ','.', 'ː','-']);

    function stripColorSpans(html){
      return html
        .replace(/<span[^>]*class="[^"]*\bphoneme-(?:vowel|consonant)\b[^"]*"[^>]*>/gi,'')
        .replace(/<\/span>/gi,'');
    }

    function colorizePhonemes(html){
      if(!html) return '';
      // 先移除舊的顏色 span，並保留 <u>
      const src = stripColorSpans(html);
      let out = '', i = 0, inTag = false;
      while(i < src.length){
        const ch = src[i];

        // 保留任何 HTML 標籤（含 <u>…</u>）
        if(ch === '<'){
          const j = src.indexOf('>', i);
          if(j === -1){ out += ch; i++; continue; }
          out += src.slice(i, j+1);
          i = j + 1;
          continue;
        }

        // 不上色的字元
        if(NEUTRAL_CHARS.has(ch)){
          out += ch; i++; continue;
        }

        // 上色（按單一字元）
        if(VOWEL_CHARS.has(ch)){
          out += `<span class="phoneme-vowel">${ch}</span>`;
        }else if(CONSONANT_CHARS.has(ch)){
          out += `<span class="phoneme-consonant">${ch}</span>`;
        }else{
          out += ch;
        }
        i++;
      }
      return out;
    }

    // ========== 全域：標籤中文 ==========
    const tagNames = {
      all: "全部",
      irregular: "不規則拼寫",
      closed: "閉音節-短母音",
      floss: "重複子音字尾 (FLOSS-Z)",
      digraph: "雙字母子音",
      cluster: "子音群",
      suffix: "字尾後綴",
      rcontrolled: "母音 + 'r'",
      open: "開音節-長母音",
      cle: "子音 + 'le'",
      magic_e: "長母音 + 靜音 'e'",
      vowel_team: "母音組合",
      diphthong: "雙母音",
      silent_consonant: "不發音子音字母"
    };

    // ========== 基本狀態 ==========
    const TOPICS_URL = 'topics.json';
    const CACHE = { topics: null, data: {} };
    const loadingState = new Set(); // 避免重複抓同一檔

    // ========== fetch 逾時包裝 ==========
    function fetchWithTimeout(url, opts={}, timeout=8000){
      return Promise.race([
        fetch(url, opts),
        new Promise((_, rej)=> setTimeout(()=>rej(new Error('Timeout')), timeout))
      ]);
    }

    // ========== 音訊播放與路徑 ==========
    const AUDIO_BASE = './audio/';
    let levelFolder = ''; // e.g. 'numbers-1'

    function slugifyWord(w){
      return String(w||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
    }
    function audioUrlForWord(item){
      if (item.audio) return item.audio; // 每筆可自帶 audio 路徑
      return `${AUDIO_BASE}${levelFolder}/${slugifyWord(item.word)}.mp3`;
    }

    // ====== 音檔快取（phoneme & 單字） ======
    const AUDIO_CACHE = new Map(); // url -> { blobUrl, t }
    const CACHE_MAX = 120;         // 最多保留 120 個音檔

    function cachePut(url, blobUrl){
      AUDIO_CACHE.set(url, { blobUrl, t: Date.now() });
      // 簡易 LRU：超過就踢最舊的
      if (AUDIO_CACHE.size > CACHE_MAX){
        let oldestKey=null, oldestT=Infinity;
        for (const [k,v] of AUDIO_CACHE){
          if (v.t < oldestT){ oldestT=v.t; oldestKey=k; }
        }
        if (oldestKey){
          try{ URL.revokeObjectURL(AUDIO_CACHE.get(oldestKey).blobUrl); }catch{}
          AUDIO_CACHE.delete(oldestKey);
        }
      }
    }
    function cacheGet(url){
      const hit = AUDIO_CACHE.get(url);
      if (hit){ hit.t = Date.now(); return hit.blobUrl; }
      return null;
    }
    async function ensureAudio(url){
      if (!url) return null;
      const hit = cacheGet(url);
      if (hit) return hit;
      const r = await fetchWithTimeout(url, {}, 12000);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const blob = await r.blob();
      const blobUrl = URL.createObjectURL(blob);
      cachePut(url, blobUrl);
      return blobUrl;
    }
    async function playAudioSmart(url, btn){
      try{
        const src = await ensureAudio(url);
        if (!src) return;
        const p = new Audio();
        p.src = src;
        await p.play();
      }catch(e){
        if(btn){ const o=btn.textContent; btn.textContent='❌'; setTimeout(()=>btn.textContent=o,800); }
        console.warn('播放失敗：', url, e);
      }
    }

    // ========== 音素對照：只讀 JSON，不做規則 ==========
    let PHONEME = { files: {} };
    fetchWithTimeout('data/phoneme-audio.json')
      .then(r => r.ok ? r.json() : {files:{}})
      .then(j => { PHONEME = j || {files:{}}; })
      .catch(()=>{ /* 忽略，查不到就不播 */ });

    function phonemeUrl(raw, isPhonics){
      // 先嘗試原字串
      if (PHONEME.files && PHONEME.files[raw]) return PHONEME.files[raw];

      // 清理：移除 HTML 標籤、斜線、重音記號與空白
      const key = String(raw)
        .replace(/<[^>]+>/g,'')  // 去 HTML（包含我們包的 <span> 與 <u>）
        .replace(/'/g,'')        // 去重音符號
        .trim()
        .replace(/^\/|\/$/g,'')  // 去頭尾斜線
        .replace(/\s+/g,'');     // 去空白

      return (PHONEME.files && PHONEME.files[key]) ? PHONEME.files[key] : null;
    }

    // ========== 事件委派 ==========
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.audio-button');
      if(btn){
        const url = btn.getAttribute('data-audio-url');
        if(url) playAudioSmart(url, btn);
        return;
      }
      const cell = e.target.closest('.phoneme-box');
      if(cell){
        const raw = isPhonicsMode ? cell.innerHTML : cell.textContent;
        const url = phonemeUrl(raw, isPhonicsMode);
        if(!url){ cell.style.background='#fee2e2'; setTimeout(()=>cell.style.background='',400); return; }
        playAudioSmart(url, cell);
        return;
      }
      const nav = e.target.closest('[data-page-target]');
      if(nav){
        showPage(nav.getAttribute('data-page-target'));
        return;
      }
      const retry = e.target.closest('[data-action="reload"]');
      if(retry){ location.reload(); }
    });

    // —— 預抓事件：桌機用 mouseenter、行動用 touchstart —— 
    function setupAudioPrefetchListeners(){
      if (DISABLE_PREFETCH) return;
      if (!IS_TOUCH) {
        document.addEventListener('mouseenter', (e)=>{
          const btn = e.target.closest('.audio-button'); if(!btn) return;
          const url = btn.getAttribute('data-audio-url'); if(url) ensureAudio(url).catch(()=>{});
        }, true);
      }
      document.addEventListener('touchstart', (e)=>{
        const btn = e.target.closest('.audio-button'); if(!btn) return;
        const url = btn.getAttribute('data-audio-url'); if(url) ensureAudio(url).catch(()=>{});
      }, { passive:true });
    }
    setupAudioPrefetchListeners();

    // ========== 狀態與渲染 ==========
    let selectedFilter = sessionStorage.getItem('selectedFilter') || 'all';
    let currentTopicData=[];
    let isPhonicsMode=false;

    function initTopicPage(contentId){
      const cnt=document.getElementById(contentId);
      if(!cnt) return;

      // 篩選器
      const allTags=['all','irregular','closed','floss','digraph','cluster','suffix','rcontrolled','open','cle','magic_e','vowel_team','diphthong','silent_consonant'];
      const usedTags=new Set(['all']);
      currentTopicData.forEach(w=>{ (w.tags||[]).forEach(t=>usedTags.add(t)); });
      const existing=allTags.filter(t=>usedTags.has(t));

      let legendHTML='<ul class="legend">';
      existing.forEach(t=>{
        const name = tagNames[t] || t;
        const cls=(t==='all')?'tag-all':`tag-${t}`;
        const sel=(t===selectedFilter)?'selected':'';
        legendHTML+=`<li class="legend-item ${cls} ${sel}" data-filter="${t}">${name}</li>`;
      });
      legendHTML+='</ul>';

      const toggleHTML=`
        <div class="toggle-container">
          <span class="toggle-label-ipa">IPA</span>
          <label class="switch">
            <input type="checkbox" id="toggle_${contentId}" ${isPhonicsMode?'checked':''}>
            <span class="slider"></span>
          </label>
          <span class="toggle-label-phonics">簡化音標</span>
        </div>
        <p class="attribution-note">
          IPA 根據<a href="https://christinayu_english.rakosell.com/zh/page/american-ipa-guide" target="_blank">美式英語 IPA 國際音標指南</a><br>
          Phonics 根據 <a href="https://ufli.education.ufl.edu/wp-content/uploads/2023/09/UFLI-Sound-Wall-rev.pdf" target="_blank">UFLI phonemes</a>
        </p>
      `;

      cnt.innerHTML=legendHTML+toggleHTML+`<div class="topic-grid" id="teaching-grid-${contentId}"></div>`;

      // 篩選器點擊
      cnt.querySelectorAll('.legend-item').forEach(li=>{
        li.addEventListener('click',()=>{
          selectedFilter = li.getAttribute('data-filter')||'all';
          sessionStorage.setItem('selectedFilter', selectedFilter);
          cnt.querySelectorAll('.legend-item').forEach(x=>x.classList.remove('selected'));
          li.classList.add('selected');
          applyFilters(contentId);
        });
      });

      const tog=cnt.querySelector(`#toggle_${contentId}`);
      if(tog){ tog.addEventListener('change',()=>{ isPhonicsMode=tog.checked; renderCards(contentId); }); }

      renderCards(contentId);
      highlightIfPending(contentId);

      // —— 預載本頁可見的 phoneme 音檔
      if (!DISABLE_PREFETCH){
        setTimeout(()=>{ 
          try{
            const grid = document.getElementById(`teaching-grid-${contentId}`);
            if(!grid) return;
            const urls = new Set();
            grid.querySelectorAll('.phoneme-box').forEach(cell=>{
              const raw = isPhonicsMode ? cell.innerHTML : cell.textContent;
              const u = phonemeUrl(raw, isPhonicsMode);
              if(u) urls.add(u);
            });
            Array.from(urls).slice(0, PREFETCH_PHONEMES).forEach(u=>{ ensureAudio(u).catch(()=>{}); });
          }catch(e){}
        }, 0);
      }
    }

    function renderCards(contentId){
      const grid = document.getElementById(`teaching-grid-${contentId}`);
      if(!grid) return;
      grid.innerHTML='';
      currentTopicData.forEach(w=>{
        const tagsAttr = (w.tags||[]).join(',');
        const badges = (w.tags||[])
          .map(t => `<span class="category-tag tag-${t}">${escapeHtml(tagNames[t] || t)}</span>`)
          .join('');

        const modeKey = isPhonicsMode?'phonics':'phonemes';
        const useArr = (w[modeKey]||w.phonemes||[]);
        const labelArr = (w.graphemes||[]);
        const heartArr = (w.hearts||[]);

        const cols = Math.max(labelArr.length, useArr.length);
        let cells='';
        for(let i=0;i<cols;i++){
          const g = labelArr[i]||'';
          const p = useArr[i]||'';
          const heart = heartArr[i]?'<span class="heart-symbol">❤</span>':'';
          const phClass = (isPhonicsMode)?'is-phonics':'';
          const pHtmlRaw = isPhonicsMode ? sanitizePhonemeHtml(p, true) : escapeHtml(p);
          const pHtml = colorizePhonemes(pHtmlRaw); // ← 套用紅/藍
          cells+=`
            <div class="grapheme-box box">${escapeHtml(g)}${heart}</div>
            <div class="phoneme-box box ${phClass}">${pHtml}</div>
          `;
        }

        const audioURL = audioUrlForWord(w);
        const card=`
          <article class="word-card" data-tags="${escapeAttr(tagsAttr)}" data-word="${escapeAttr(String(w.word||'').toLowerCase())}">
            <div class="card-header">
              <div class="card-title">
                <span class="word-number">${escapeHtml(w.number ?? '')}</span>
                <span class="word-text">${escapeHtml(w.word||'')}</span>
              </div>
              <button class="audio-button" data-audio-url="${escapeAttr(audioURL)}" aria-label="播放單字發音">🔊</button>
            </div>
            <div class="card-body">
              <div class="badges">${badges}</div>
              <div class="boxes-grid" style="grid-template-columns:repeat(${cols},max-content)">${cells}</div>
              <div class="word-tips"><span class="tips-icon">💡</span><span>${escapeHtml(w.hint||'')}</span></div>
            </div>
          </article>
        `;
        grid.insertAdjacentHTML('beforeend',card);
      });
      applyFilters(contentId);

      // —— 預載前幾個單字發音
      if (!DISABLE_PREFETCH){
        try{
          const warm = (currentTopicData||[]).slice(0, PREFETCH_WORDS).map(w => audioUrlForWord(w)).filter(Boolean);
          warm.forEach(u=>{ ensureAudio(u).catch(()=>{}); });
        }catch(e){}
      }
    }

    function applyFilters(contentId){
      const grid = document.getElementById(`teaching-grid-${contentId}`);
      if(!grid) return;
      const cards = grid.querySelectorAll('.word-card');
      if(selectedFilter === 'all'){ cards.forEach(c=>c.classList.remove('hidden')); return; }
      cards.forEach(c=>{
        const tags = (c.getAttribute('data-tags')||'').split(',').filter(Boolean);
        c.classList.toggle('hidden', !tags.includes(selectedFilter));
      });
    }

    // ========== 搜尋 ==========
    let WORD_INDEX = {};
    function buildWordIndexFromAll(){
      WORD_INDEX = {};
      (CACHE.topics?.topics||[]).forEach(t=>{
        t.levels.forEach((lv, idx)=>{
          const items = CACHE.data[lv.src]?.items || [];
          items.forEach(w=>{
            const key = String(w.word||'').trim().toLowerCase();
            if(key && !WORD_INDEX[key]) WORD_INDEX[key] = { slug: t.slug, levelIndex: idx };
          });
        });
      });
    }
    function goToWord(wordRaw){
      const input = String(wordRaw||'').trim().toLowerCase();
      const msgEl = document.getElementById('searchMsg');
      if(!input){ msgEl.textContent='請輸入單字'; return; }
      const hit = WORD_INDEX[input];
      if(!hit){ msgEl.textContent=`找不到：${wordRaw}`; return; }
      msgEl.textContent='';
      const pageId = `${hit.slug}_${hit.levelIndex+1}_Page`;
      window.PhonicsApp.pendingHighlight = input;
      showPage(pageId);
    }
    function initSearchBar(){
      const inp=document.getElementById('globalSearchInput');
      const btn=document.getElementById('globalSearchBtn');
      if(!inp||!btn) return;
      btn.addEventListener('click',()=>goToWord(inp.value));
      inp.addEventListener('keydown',(e)=>{ if(e.key==='Enter') goToWord(inp.value); });
    }
    function highlightIfPending(contentId){
      const target=(window.PhonicsApp.pendingHighlight||'').toLowerCase();
      if(!target) return;
      const grid=document.getElementById(`teaching-grid-${contentId}`);
      if(!grid) return;
      const escaped = (window.CSS && CSS.escape) ? CSS.escape(target)
        : target.replace(/[!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, "\\$&");
      const card=grid.querySelector(`.word-card[data-word="${escaped}"]`);
      if(card){
        card.classList.add('search-hit');
        card.scrollIntoView({behavior:'smooth',block:'center'});
        setTimeout(()=>card.classList.remove('search-hit'),1600);
      }
      window.PhonicsApp.pendingHighlight='';
    }

    // ========== 導航（依 topics.json 動態生成） ==========
    function showPage(pageId){
      document.querySelectorAll('.page-section').forEach(p=>p.classList.remove('active'));
      const active = document.getElementById(pageId);
      if(!active) return;
      active.classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });

      const m = pageId.match(/^(.+?)_(\d+)_Page$/);
      if(!m) return; // home
      const slug = m[1], levelIndex = Number(m[2])-1;
      const contentId = `${slug}_${levelIndex+1}_Content`;

      const topic = (CACHE.topics?.topics||[]).find(x=>x.slug===slug);
      const lv = topic?.levels?.[levelIndex];
      if(!lv) return;

      // e.g. data/numbers-1.json -> numbers-1
      levelFolder = (lv.src||'').replace(/^data\//,'').replace(/\.json$/,'').replace(/^\//,'');

      if(!CACHE.data[lv.src] && !loadingState.has(lv.src)){
        const t = document.getElementById(contentId);
        if (t) t.innerHTML = '<p style="color:#666">載入中…</p>';
        loadingState.add(lv.src);
        fetchWithTimeout(lv.src)
          .then(r=>{ if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
          .then(json=>{
            CACHE.data[lv.src]=json; loadingState.delete(lv.src);
            if(document.getElementById(pageId)?.classList.contains('active')){
              currentTopicData = json.items||[];
              initTopicPage(contentId);
            }
          })
          .catch(e=>{
            loadingState.delete(lv.src);
            const t=document.getElementById(contentId);
            if(t) t.innerHTML = `<p style="color:#b91c1c">載入失敗：${escapeHtml(lv.src)}（${escapeHtml(e.message)}） <button data-action="reload">重試</button></p>`;
          });
      }else if(CACHE.data[lv.src]){
        currentTopicData = CACHE.data[lv.src].items||[];
        initTopicPage(contentId);
      }
    }
    // 對外只暴露命名空間
    window.PhonicsApp.showPage = showPage;

    function buildHomeAndSections(){
      const list = document.getElementById('topicList');
      const main = document.querySelector('main');

      (CACHE.topics?.topics||[]).forEach(t=>{
        t.levels.forEach((lv, idx)=>{
          const label = lv.label || `-${idx+1}`;
          list.insertAdjacentHTML('beforeend', `
            <li class="topic-list-item" data-page-target="${t.slug}_${idx+1}_Page">
              ${escapeHtml(t.title)}（${escapeHtml(label)}）
            </li>
          `);
          main.insertAdjacentHTML('beforeend', `
            <section id="${t.slug}_${idx+1}_Page" class="page-section">
              <button class="back-button" data-page-target="homePage"><i class="fa-solid fa-arrow-left"></i>返回目錄</button>
              <h1>${escapeHtml(t.title)}（${escapeHtml(label)}）</h1>
              <div id="${t.slug}_${idx+1}_Content"></div>
            </section>
          `);
        });
      });
    }

    // ========== 啟動 ==========
    document.addEventListener('DOMContentLoaded', async ()=>{
      initSearchBar();
      try{
        const resp = await fetchWithTimeout(TOPICS_URL);
        if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
        CACHE.topics = await resp.json();
      }catch(e){
        console.error(e);
        document.getElementById('topicList').innerHTML =
          `<li class="topic-list-item" style="color:#b91c1c">
            讀取 topics.json 失敗（${escapeHtml(e.message)}）
            <button data-action="reload" style="margin-left:.5rem">重試</button>
          </li>`;
        return;
      }
      buildHomeAndSections();

      await Promise.allSettled(
        (CACHE.topics.topics||[]).flatMap(t => t.levels.map(lv =>
          fetchWithTimeout(lv.src).then(r=>r.ok?r.json():null).then(j=>{ if(j) CACHE.data[lv.src]=j; })
        ))
      );
      buildWordIndexFromAll();

      document.querySelectorAll('.page-section').forEach(p=>p.classList.remove('active'));
      document.getElementById('homePage').classList.add('active');
    });
  </script>
</body>
</html>
